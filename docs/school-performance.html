<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spreadsheet Munging Strategies</title>
  <meta name="description" content="Spreadsheet Munging Strategies">
  <meta name="generator" content="bookdown 0.7.14 and GitBook 2.6.7">

  <meta property="og:title" content="Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="cashflows.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-45097885-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-45097885-10');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyish.html"><a href="tidyish.html"><i class="fa fa-check"></i><b>2</b> Tidy-ish tables</a><ul>
<li class="chapter" data-level="2.1" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>2.1</b> Clean &amp; tidy tables</a></li>
<li class="chapter" data-level="2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html"><i class="fa fa-check"></i><b>2.2</b> Almost-tidy tables</a><ul>
<li class="chapter" data-level="2.2.1" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>2.2.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="2.2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>2.2.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tidy-formatted-rows.html"><a href="tidy-formatted-rows.html"><i class="fa fa-check"></i><b>2.3</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="2.4" data-path="tidy-formatted-cells.html"><a href="tidy-formatted-cells.html"><i class="fa fa-check"></i><b>2.4</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="2.5" data-path="layered-formatting.html"><a href="layered-formatting.html"><i class="fa fa-check"></i><b>2.5</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="2.6" data-path="hierarchies-in-formatting.html"><a href="hierarchies-in-formatting.html"><i class="fa fa-check"></i><b>2.6</b> Hierarchies in formatting</a></li>
<li class="chapter" data-level="2.7" data-path="tidy-sentinel.html"><a href="tidy-sentinel.html"><i class="fa fa-check"></i><b>2.7</b> Sentinel values in non-text columns</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pivot.html"><a href="pivot.html"><i class="fa fa-check"></i><b>3</b> Pivot tables</a><ul>
<li class="chapter" data-level="3.1" data-path="pivot-simple.html"><a href="pivot-simple.html"><i class="fa fa-check"></i><b>3.1</b> Simple unpivoting</a><ul>
<li class="chapter" data-level="3.1.1" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-of-text-column-headers-left-aligned"><i class="fa fa-check"></i><b>3.1.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.1.2" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned"><i class="fa fa-check"></i><b>3.1.2</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.1.3" data-path="pivot-simple.html"><a href="pivot-simple.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting"><i class="fa fa-check"></i><b>3.1.3</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pivot-complex.html"><a href="pivot-complex.html"><i class="fa fa-check"></i><b>3.2</b> Complex unpivoting</a><ul>
<li class="chapter" data-level="3.2.1" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1"><i class="fa fa-check"></i><b>3.2.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.2.2" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-columns-of-text-row-headers-top-aligned"><i class="fa fa-check"></i><b>3.2.2</b> Two clear columns of text row headers, top-aligned</a></li>
<li class="chapter" data-level="3.2.3" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1"><i class="fa fa-check"></i><b>3.2.3</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.2.4" data-path="pivot-complex.html"><a href="pivot-complex.html#centre-aligned-headers"><i class="fa fa-check"></i><b>3.2.4</b> Centre-aligned headers</a></li>
<li class="chapter" data-level="3.2.5" data-path="pivot-complex.html"><a href="pivot-complex.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting-1"><i class="fa fa-check"></i><b>3.2.5</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="3.2.6" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.6</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.7" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.7</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.8" data-path="pivot-complex.html"><a href="pivot-complex.html#repeated-rowscolumns-of-headers-within-the-table"><i class="fa fa-check"></i><b>3.2.8</b> Repeated rows/columns of headers within the table</a></li>
<li class="chapter" data-level="3.2.9" data-path="pivot-complex.html"><a href="pivot-complex.html#headers-amongst-the-data"><i class="fa fa-check"></i><b>3.2.9</b> Headers amongst the data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="small-multiples.html"><a href="small-multiples.html"><i class="fa fa-check"></i><b>4</b> Small multiples</a><ul>
<li class="chapter" data-level="4.1" data-path="small-multiples-with-all-headers-present-for-each-multiple.html"><a href="small-multiples-with-all-headers-present-for-each-multiple.html"><i class="fa fa-check"></i><b>4.1</b> Small multiples with all headers present for each multiple</a></li>
<li class="chapter" data-level="4.2" data-path="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><a href="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><i class="fa fa-check"></i><b>4.2</b> Same table in several worksheets/files (using the sheet/file name)</a></li>
<li class="chapter" data-level="4.3" data-path="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><a href="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><i class="fa fa-check"></i><b>4.3</b> Same table in several worksheets/files but in different positions</a></li>
<li class="chapter" data-level="4.4" data-path="implied-multiples.html"><a href="implied-multiples.html"><i class="fa fa-check"></i><b>4.4</b> Implied multiples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="formatting.html"><a href="formatting.html"><i class="fa fa-check"></i><b>5</b> Formatting</a><ul>
<li class="chapter" data-level="5.1" data-path="an-example-formatting-lookup.html"><a href="an-example-formatting-lookup.html"><i class="fa fa-check"></i><b>5.1</b> An example formatting lookup</a></li>
<li class="chapter" data-level="5.2" data-path="common-formats.html"><a href="common-formats.html"><i class="fa fa-check"></i><b>5.2</b> Common formats</a></li>
<li class="chapter" data-level="5.3" data-path="in-cell-formatting.html"><a href="in-cell-formatting.html"><i class="fa fa-check"></i><b>5.3</b> In-cell formatting</a></li>
<li class="chapter" data-level="5.4" data-path="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><a href="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><i class="fa fa-check"></i><b>5.4</b> Multiple pieces of information in a single cell, with meaningful formatting</a></li>
<li class="chapter" data-level="5.5" data-path="superscript-symbols.html"><a href="superscript-symbols.html"><i class="fa fa-check"></i><b>5.5</b> Superscript symbols</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>6</b> Data validation</a></li>
<li class="chapter" data-level="7" data-path="formulas.html"><a href="formulas.html"><i class="fa fa-check"></i><b>7</b> Formulas</a></li>
<li class="chapter" data-level="8" data-path="other-gotchas.html"><a href="other-gotchas.html"><i class="fa fa-check"></i><b>8</b> Other gotchas</a><ul>
<li class="chapter" data-level="8.1" data-path="non-text-headers-e-g-dates.html"><a href="non-text-headers-e-g-dates.html"><i class="fa fa-check"></i><b>8.1</b> Non-text headers e.g. dates</a></li>
<li class="chapter" data-level="8.2" data-path="data-embedded-in-comments.html"><a href="data-embedded-in-comments.html"><i class="fa fa-check"></i><b>8.2</b> Data embedded in comments</a></li>
<li class="chapter" data-level="8.3" data-path="named-ranges.html"><a href="named-ranges.html"><i class="fa fa-check"></i><b>8.3</b> Named ranges</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><b>9</b> Case studies</a><ul>
<li class="chapter" data-level="9.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html"><i class="fa fa-check"></i><b>9.1</b> Australian Marriage Survey</a><ul>
<li class="chapter" data-level="9.1.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#the-full-code-listing"><i class="fa fa-check"></i><b>9.1.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.1.2" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#step-by-step"><i class="fa fa-check"></i><b>9.1.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="vaccinations.html"><a href="vaccinations.html"><i class="fa fa-check"></i><b>9.2</b> Vaccinations</a></li>
<li class="chapter" data-level="9.3" data-path="us-crime.html"><a href="us-crime.html"><i class="fa fa-check"></i><b>9.3</b> US Crime</a><ul>
<li class="chapter" data-level="9.3.1" data-path="us-crime.html"><a href="us-crime.html#us-crime-2"><i class="fa fa-check"></i><b>9.3.1</b> Table 2</a></li>
<li class="chapter" data-level="9.3.2" data-path="us-crime.html"><a href="us-crime.html#us-crime-3"><i class="fa fa-check"></i><b>9.3.2</b> Table 3</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html"><i class="fa fa-check"></i><b>9.4</b> Toronto Transit Commission</a><ul>
<li class="chapter" data-level="9.4.1" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#the-full-code-listing-1"><i class="fa fa-check"></i><b>9.4.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.4.2" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#step-by-step-1"><i class="fa fa-check"></i><b>9.4.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="ground-water.html"><a href="ground-water.html"><i class="fa fa-check"></i><b>9.5</b> Ground water</a></li>
<li class="chapter" data-level="9.6" data-path="cashflows.html"><a href="cashflows.html"><i class="fa fa-check"></i><b>9.6</b> Cashflows</a></li>
<li class="chapter" data-level="9.7" data-path="school-performance.html"><a href="school-performance.html"><i class="fa fa-check"></i><b>9.7</b> School performance</a><ul>
<li class="chapter" data-level="9.7.1" data-path="school-performance.html"><a href="school-performance.html#sheet-1"><i class="fa fa-check"></i><b>9.7.1</b> Sheet 1</a></li>
<li class="chapter" data-level="9.7.2" data-path="school-performance.html"><a href="school-performance.html#sheet-2"><i class="fa fa-check"></i><b>9.7.2</b> Sheet 2</a></li>
<li class="chapter" data-level="9.7.3" data-path="school-performance.html"><a href="school-performance.html#sheet-3"><i class="fa fa-check"></i><b>9.7.3</b> Sheet 3</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="school-performance" class="section level2">
<h2><span class="header-section-number">9.7</span> School performance</h2>
<p>A certain United States state education department provides its schools with
spreadsheets of statistics. I bet the children in that state get a great
education, because there’s at least one R enthusiast on the staff whose
curiosity has never left them.</p>
<div id="sheet-1" class="section level3">
<h3><span class="header-section-number">9.7.1</span> Sheet 1</h3>
<p>The first sheet is an example of <a href="pivot-complex.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting">mixed headers in column 1 being distinguished
by bold
formatting</a>.
Filter for the bold cells in column 1 and assign them to a variable. Then
<code>behead()</code> the other headers, and finally <code>enhead()</code> the bold headers back on.</p>
<p><img src="images/school1.png" /></p>
<p><a href="https://github.com/nacnudus/smungs/blob/master/inst/extdata/school.xlsx?raw=true">Download the
file</a>,
modified from an original source provided to the author.</p>
<pre class="sourceCode r"><code class="sourceCode r">cells &lt;-
<span class="st">  </span><span class="kw">xlsx_cells</span>(smungs<span class="op">::</span>school, <span class="st">&quot;Sheet1&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank)

formats &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(smungs<span class="op">::</span>school)

bold_headers &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">==</span><span class="st"> </span>1L, formats<span class="op">$</span>local<span class="op">$</span>font<span class="op">$</span>bold[local_format_id]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">bold_header =</span> character)

cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;plain-header&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">enhead</span>(bold_headers, <span class="st">&quot;WNW&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, data_type, numeric, metric, <span class="st">`</span><span class="dt">plain-header</span><span class="st">`</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spatter</span>(metric) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row)</code></pre>
<pre><code>## # A tibble: 21 x 10
##    `plain-header` `% Advanced` `% Needs Improv… `% Proficient`
##    &lt;chr&gt;                 &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;
##  1 All Students          0.515           0.0297          0.446
##  2 Economically …        0.333           0.0667          0.567
##  3 Non-Economica…        0.592           0.0141          0.394
##  4 Students w/ D…       NA              NA              NA    
##  5 Non-Disabled          0.565           0.0217          0.413
##  6 ELL                  NA              NA              NA    
##  7 Non-ELL               0.525           0.0202          0.444
##  8 African Amer.…       NA              NA              NA    
##  9 Asian                NA              NA              NA    
## 10 Hispanic/Lati…       NA              NA              NA    
## # ... with 11 more rows, and 6 more variables: `% Proficient or
## #   Higher` &lt;dbl&gt;, `% Warning/ Failing` &lt;dbl&gt;, CPI &lt;dbl&gt;, `Median
## #   SGP` &lt;dbl&gt;, `N Included` &lt;dbl&gt;, `N Included in SGP` &lt;dbl&gt;</code></pre>
</div>
<div id="sheet-2" class="section level3">
<h3><span class="header-section-number">9.7.2</span> Sheet 2</h3>
<p>The second sheet is variation on <a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1">two clear rows of text column headers, left
aligned</a>. Here, there
are three rows of colum headers. The first row is left-aligned, and the second
and third rows are directly above the data cells. But the second row is blank
above columns D and E. That doesn’t actually matter; in the output, <code>header_2</code>
will be <code>NA</code> for data from those columns.</p>
<p><img src="images/school2.png" /></p>
<p><a href="https://github.com/nacnudus/smungs/blob/master/inst/extdata/school.xlsx?raw=true">Download the
file</a>,
modified from an original source provided to the author.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">xlsx_cells</span>(smungs<span class="op">::</span>school, <span class="st">&quot;Sheet2&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, col, address, data_type, character, numeric, is_blank) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">character =</span> <span class="kw">str_trim</span>(character)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;header_1&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;header_2&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;header_3&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;classroom&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank, <span class="op">!</span><span class="kw">is.na</span>(header_<span class="dv">3</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">arrange</span>(col, row)</code></pre>
<pre><code>## # A tibble: 32 x 11
##      row   col address data_type character numeric is_blank header_1
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;lgl&gt;    &lt;chr&gt;   
##  1     5     4 D5      character 10         NA     FALSE    MCAS Su…
##  2     6     4 D6      character 10         NA     FALSE    MCAS Su…
##  3     7     4 D7      character 10         NA     FALSE    MCAS Su…
##  4     8     4 D8      character 10         NA     FALSE    MCAS Su…
##  5     5     5 E5      character 4          NA     FALSE    MCAS Su…
##  6     6     5 E6      character 8          NA     FALSE    MCAS Su…
##  7     7     5 E7      character 5          NA     FALSE    MCAS Su…
##  8     8     5 E8      character 10         NA     FALSE    MCAS Su…
##  9     5     6 F5      numeric   &lt;NA&gt;        0.342 FALSE    Possibl…
## 10     6     6 F6      numeric   &lt;NA&gt;        0.319 FALSE    Possibl…
## # ... with 22 more rows, and 3 more variables: header_2 &lt;chr&gt;,
## #   header_3 &lt;chr&gt;, classroom &lt;chr&gt;</code></pre>
</div>
<div id="sheet-3" class="section level3">
<h3><span class="header-section-number">9.7.3</span> Sheet 3</h3>
<p>The third sheet is variation on <a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1">two clear rows of text column headers, left
aligned</a>, with a nasty
catch. The creator of the spreadsheet didn’t merge cells to make space for more
words. They didn’t even ‘centre across selection’ (which is sometimes safer
than merging cells). Instead, they wrote each word on a separate line, meaning
it is ambiguous whether a cell part of another header, or a header in its own
right.</p>
<p><img src="images/school3.png" /></p>
<p><a href="https://github.com/nacnudus/smungs/blob/master/inst/extdata/school.xlsx?raw=true">Download the
file</a>,
modified from an original source provided to the author.</p>
<p>Compare columns C and D. Column C has a single header, “Avg Years w/ Class
Data”, written across four cells. Column D has two levels of headers, “Years in
MA” first, then “% 3+” nested within it (and written across two cells). There’s
no way for a machine to tell which cells are whole headers, and which are parts
of headers.</p>
<p>We can deal with this by first treating every cell as a header in its own right,
and then concatenating the headers of rows 2 to 5. Using the <code>&quot;NNW&quot;</code> direction,
headers like “Years in MA” in cell D4 will be carried to the right, which is
good. Unfortunately so will headers like “# Students” in cell B2, which we’ll
just have to put up with.</p>
<pre class="sourceCode r"><code class="sourceCode r">cells &lt;-
<span class="st">  </span><span class="kw">xlsx_cells</span>(smungs<span class="op">::</span>school, <span class="st">&quot;Sheet3&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric)

x &lt;-
<span class="st">  </span>cells <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;place&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;category&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric-cell-1&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Treat every cell in every row as a header</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric-cell-2&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric-cell-3&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric-cell-4&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;NNW&quot;</span>, <span class="st">&quot;metric-cell-5&quot;</span>)
<span class="kw">glimpse</span>(x)</code></pre>
<pre><code>## Observations: 36
## Variables: 12
## $ row             &lt;int&gt; 7, 8, 9, 7, 8, 9, 7, 8, 9, 7, 8, 9, 7, 8, 9, 7...
## $ col             &lt;int&gt; 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8...
## $ data_type       &lt;chr&gt; &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, &quot;n...
## $ character       &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ numeric         &lt;dbl&gt; 1.000000000, 1.000000000, 1.000000000, 0.84277...
## $ place           &lt;chr&gt; &quot;State (All Students)&quot;, &quot;Region&quot;, &quot;School&quot;, &quot;S...
## $ category        &lt;chr&gt; &quot;STUDENTS&quot;, &quot;STUDENTS&quot;, &quot;STUDENTS&quot;, &quot;EDUCATOR ...
## $ `metric-cell-1` &lt;chr&gt; &quot;# Students&quot;, &quot;# Students&quot;, &quot;# Students&quot;, &quot;# S...
## $ `metric-cell-2` &lt;chr&gt; &quot;Avg&quot;, &quot;Avg&quot;, &quot;Avg&quot;, &quot;Avg&quot;, &quot;Avg&quot;, &quot;Avg&quot;, &quot;Avg...
## $ `metric-cell-3` &lt;chr&gt; &quot;Years w/&quot;, &quot;Years w/&quot;, &quot;Years w/&quot;, &quot;Years in ...
## $ `metric-cell-4` &lt;chr&gt; &quot;Class&quot;, &quot;Class&quot;, &quot;Class&quot;, &quot;%&quot;, &quot;%&quot;, &quot;%&quot;, &quot;%&quot;,...
## $ `metric-cell-5` &lt;chr&gt; &quot;Data&quot;, &quot;Data&quot;, &quot;Data&quot;, &quot;3+&quot;, &quot;3+&quot;, &quot;3+&quot;, &quot;1-2...</code></pre>
<p>Above you can see that every cell in every header row has been treated as a
header in its own right, e.g. <code>&quot;Avg&quot;</code> is a level-2 header, and <code>&quot;Years w/&quot;</code> is a
level-3 header. The next step is to paste them together into a single header.</p>
<pre class="sourceCode r"><code class="sourceCode r">x &lt;-
<span class="st">  </span>x <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># Replace NA with &quot;&quot; otherwise unite() will spell it as &quot;NA&quot;.</span>
<span class="st">  </span><span class="co"># This is a common irritation.</span>
<span class="st">  </span><span class="co"># https://stackoverflow.com/questions/13673894/suppress-nas-in-paste</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;metric-cell-&quot;</span>)), replace_na, <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">unite</span>(<span class="st">&quot;metric&quot;</span>, <span class="kw">starts_with</span>(<span class="st">&quot;metric-cell-&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">metric =</span> <span class="kw">str_trim</span>(metric))
<span class="kw">glimpse</span>(x)</code></pre>
<pre><code>## Observations: 36
## Variables: 8
## $ row       &lt;int&gt; 7, 8, 9, 7, 8, 9, 7, 8, 9, 7, 8, 9, 7, 8, 9, 7, 8, 9...
## $ col       &lt;int&gt; 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8...
## $ data_type &lt;chr&gt; &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric...
## $ character &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, ...
## $ numeric   &lt;dbl&gt; 1.000000000, 1.000000000, 1.000000000, 0.842777337, ...
## $ place     &lt;chr&gt; &quot;State (All Students)&quot;, &quot;Region&quot;, &quot;School&quot;, &quot;State (...
## $ category  &lt;chr&gt; &quot;STUDENTS&quot;, &quot;STUDENTS&quot;, &quot;STUDENTS&quot;, &quot;EDUCATOR EXPERI...
## $ metric    &lt;chr&gt; &quot;# Students Avg Years w/ Class Data&quot;, &quot;# Students Av...</code></pre>
<p>Now the headers are manageable. They aren’t perfect – the <code>&quot;# Students&quot;</code>
header has leaked into <code>&quot;# Students Avg Years w/ Class Data&quot;</code>, but that can be
cleaned up manually later. At least <code>&quot;# Students Avg Years w/ Class Data&quot;</code> is
within the <code>&quot;STUDENTS&quot;</code> category, which is the hard part.</p>
<p>Spreading this data is the final step to make it easy to work with.</p>
<pre class="sourceCode r"><code class="sourceCode r">x <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(place, category, metric, numeric) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(place, numeric) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">print</span>(<span class="dt">n =</span> <span class="ot">Inf</span>)</code></pre>
<pre><code>## # A tibble: 12 x 5
##    category        metric               Region   School `State (All Stude…
##    &lt;chr&gt;           &lt;chr&gt;                 &lt;dbl&gt;    &lt;dbl&gt;              &lt;dbl&gt;
##  1 EDUCATOR EXPER… # Students Avg Ye…  4.39e-2   0                  0.0535
##  2 EDUCATOR EXPER… # Students Avg Ye…  5.99e-2   0.154              0.104 
##  3 EDUCATOR EXPER… # Students Avg Ye…  8.96e-1   0.846              0.843 
##  4 EDUCATOR EXPER… # Students PTS % …  2.48e-1   0.0684             0.247 
##  5 EDUCATOR EXPER… # Students PTS Ye…  7.52e-1   0.932              0.753 
##  6 EDUCATOR QUALI… # Students % % In…  9.44e-1   1                  0.903 
##  7 EDUCATOR QUALI… # Students % % No… NA        NA                 NA     
##  8 EDUCATOR QUALI… # Students % % SE… NA        NA                 NA     
##  9 EDUCATOR QUALI… # Students % Long…  1.82e-3   0                  0.0112
## 10 EDUCATOR QUALI… # Students % Out …  5.56e-2   0                  0.0965
## 11 STUDENTS        # Students          6.25e+2 116             738499     
## 12 STUDENTS        # Students Avg Ye…  1.00e+0   1                  1</code></pre>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="cashflows.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": true,
"linkedin": true,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/nacnudus/spreadsheet-munging-strategies/edit/master/case-studies.Rmd",
"text": "Edit"
},
"download": ["spreadsheet-munging-strategies.pdf", "spreadsheet-munging-strategies.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

</body>

</html>
