<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Spreadsheet Munging Strategies</title>
  <meta name="description" content="Spreadsheet Munging Strategies">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="tidy-formatted-rows.html">
<link rel="next" href="layered-formatting.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-45097885-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-45097885-10');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a><ul>
<li class="chapter" data-level="1.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyish.html"><a href="tidyish.html"><i class="fa fa-check"></i><b>2</b> Tidy-ish tables</a><ul>
<li class="chapter" data-level="2.1" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>2.1</b> Clean &amp; tidy tables</a></li>
<li class="chapter" data-level="2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html"><i class="fa fa-check"></i><b>2.2</b> Almost-tidy tables</a><ul>
<li class="chapter" data-level="2.2.1" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>2.2.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="2.2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>2.2.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tidy-formatted-rows.html"><a href="tidy-formatted-rows.html"><i class="fa fa-check"></i><b>2.3</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="2.4" data-path="tidy-formatted-cells.html"><a href="tidy-formatted-cells.html"><i class="fa fa-check"></i><b>2.4</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="2.5" data-path="layered-formatting.html"><a href="layered-formatting.html"><i class="fa fa-check"></i><b>2.5</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="2.6" data-path="hierarchies-in-formatting.html"><a href="hierarchies-in-formatting.html"><i class="fa fa-check"></i><b>2.6</b> Hierarchies in formatting</a></li>
<li class="chapter" data-level="2.7" data-path="tidy-sentinel.html"><a href="tidy-sentinel.html"><i class="fa fa-check"></i><b>2.7</b> Sentinel values in non-text columns</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pivot.html"><a href="pivot.html"><i class="fa fa-check"></i><b>3</b> Pivot tables</a><ul>
<li class="chapter" data-level="3.1" data-path="pivot-simple.html"><a href="pivot-simple.html"><i class="fa fa-check"></i><b>3.1</b> Simple unpivoting</a><ul>
<li class="chapter" data-level="3.1.1" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-of-text-column-headers-left-aligned"><i class="fa fa-check"></i><b>3.1.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.1.2" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned"><i class="fa fa-check"></i><b>3.1.2</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.1.3" data-path="pivot-simple.html"><a href="pivot-simple.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting"><i class="fa fa-check"></i><b>3.1.3</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pivot-complex.html"><a href="pivot-complex.html"><i class="fa fa-check"></i><b>3.2</b> Complex unpivoting</a><ul>
<li class="chapter" data-level="3.2.1" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1"><i class="fa fa-check"></i><b>3.2.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.2.2" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-columns-of-text-row-headers-top-aligned"><i class="fa fa-check"></i><b>3.2.2</b> Two clear columns of text row headers, top-aligned</a></li>
<li class="chapter" data-level="3.2.3" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1"><i class="fa fa-check"></i><b>3.2.3</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.2.4" data-path="pivot-complex.html"><a href="pivot-complex.html#centre-aligned-headers"><i class="fa fa-check"></i><b>3.2.4</b> Centre-aligned headers</a></li>
<li class="chapter" data-level="3.2.5" data-path="pivot-complex.html"><a href="pivot-complex.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting-1"><i class="fa fa-check"></i><b>3.2.5</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="3.2.6" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.6</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.7" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.2.7</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.8" data-path="pivot-complex.html"><a href="pivot-complex.html#repeated-rowscolumns-of-headers-within-the-table"><i class="fa fa-check"></i><b>3.2.8</b> Repeated rows/columns of headers within the table</a></li>
<li class="chapter" data-level="3.2.9" data-path="pivot-complex.html"><a href="pivot-complex.html#headers-amongst-the-data"><i class="fa fa-check"></i><b>3.2.9</b> Headers amongst the data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="small-multiples.html"><a href="small-multiples.html"><i class="fa fa-check"></i><b>4</b> Small multiples</a><ul>
<li class="chapter" data-level="4.1" data-path="small-multiples-with-all-headers-present-for-each-multiple.html"><a href="small-multiples-with-all-headers-present-for-each-multiple.html"><i class="fa fa-check"></i><b>4.1</b> Small multiples with all headers present for each multiple</a></li>
<li class="chapter" data-level="4.2" data-path="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><a href="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><i class="fa fa-check"></i><b>4.2</b> Same table in several worksheets/files (using the sheet/file name)</a></li>
<li class="chapter" data-level="4.3" data-path="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><a href="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><i class="fa fa-check"></i><b>4.3</b> Same table in several worksheets/files but in different positions</a></li>
<li class="chapter" data-level="4.4" data-path="implied-multiples.html"><a href="implied-multiples.html"><i class="fa fa-check"></i><b>4.4</b> Implied multiples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="formatting.html"><a href="formatting.html"><i class="fa fa-check"></i><b>5</b> Formatting</a><ul>
<li class="chapter" data-level="5.1" data-path="an-example-formatting-lookup.html"><a href="an-example-formatting-lookup.html"><i class="fa fa-check"></i><b>5.1</b> An example formatting lookup</a></li>
<li class="chapter" data-level="5.2" data-path="common-formats.html"><a href="common-formats.html"><i class="fa fa-check"></i><b>5.2</b> Common formats</a></li>
<li class="chapter" data-level="5.3" data-path="in-cell-formatting.html"><a href="in-cell-formatting.html"><i class="fa fa-check"></i><b>5.3</b> In-cell formatting</a></li>
<li class="chapter" data-level="5.4" data-path="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><a href="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><i class="fa fa-check"></i><b>5.4</b> Multiple pieces of information in a single cell, with meaningful formatting</a></li>
<li class="chapter" data-level="5.5" data-path="superscript-symbols.html"><a href="superscript-symbols.html"><i class="fa fa-check"></i><b>5.5</b> Superscript symbols</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>6</b> Data validation</a></li>
<li class="chapter" data-level="7" data-path="formulas.html"><a href="formulas.html"><i class="fa fa-check"></i><b>7</b> Formulas</a></li>
<li class="chapter" data-level="8" data-path="other-gotchas.html"><a href="other-gotchas.html"><i class="fa fa-check"></i><b>8</b> Other gotchas</a><ul>
<li class="chapter" data-level="8.1" data-path="non-text-headers-e-g-dates.html"><a href="non-text-headers-e-g-dates.html"><i class="fa fa-check"></i><b>8.1</b> Non-text headers e.g. dates</a></li>
<li class="chapter" data-level="8.2" data-path="data-embedded-in-comments.html"><a href="data-embedded-in-comments.html"><i class="fa fa-check"></i><b>8.2</b> Data embedded in comments</a></li>
<li class="chapter" data-level="8.3" data-path="named-ranges.html"><a href="named-ranges.html"><i class="fa fa-check"></i><b>8.3</b> Named ranges</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><b>9</b> Case studies</a><ul>
<li class="chapter" data-level="9.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html"><i class="fa fa-check"></i><b>9.1</b> Australian Marriage Survey</a><ul>
<li class="chapter" data-level="9.1.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#the-full-code-listing"><i class="fa fa-check"></i><b>9.1.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.1.2" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#step-by-step"><i class="fa fa-check"></i><b>9.1.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="vaccinations.html"><a href="vaccinations.html"><i class="fa fa-check"></i><b>9.2</b> Vaccinations</a></li>
<li class="chapter" data-level="9.3" data-path="us-crime.html"><a href="us-crime.html"><i class="fa fa-check"></i><b>9.3</b> US Crime</a><ul>
<li class="chapter" data-level="9.3.1" data-path="us-crime.html"><a href="us-crime.html#us-crime-2"><i class="fa fa-check"></i><b>9.3.1</b> Table 2</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html"><i class="fa fa-check"></i><b>9.4</b> Toronto Transit Commission</a><ul>
<li class="chapter" data-level="9.4.1" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#the-full-code-listing-1"><i class="fa fa-check"></i><b>9.4.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.4.2" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#step-by-step-1"><i class="fa fa-check"></i><b>9.4.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="ground-water.html"><a href="ground-water.html"><i class="fa fa-check"></i><b>9.5</b> Ground water</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="tidy-formatted-cells" class="section level2">
<h2><span class="header-section-number">2.4</span> Meaningfully formatted cells</h2>
<p><img src="images/annotations.png" /></p>
<p>If single cells are highlighted, rather than whole rows, then the highlights
probably indicate something about the column rather than the row. For example,
a highlighted cell in a column called “age” of a table of medical patients,
might mean “the age of this patient is uncertain”.</p>
<p>One way to deal with this is to create a new column in the final table for each
column in the original that has any highlighted cells. For example, if
highlighted cells mean “this value is uncertain”, and some cells in the <code>age</code>
and <code>height</code> columns are highlighted, then you could create two new columns:
<code>uncertain_age</code>, and <code>uncertain_height</code>, by following the procedure of
<a href="tidy-formatted-rows">meaningfully formatted rows</a> for each column <code>age</code> and
<code>height</code>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="co"># Step 1: import the table taking only cell values and ignoring the formatting</span></a>
<a class="sourceLine" id="cb37-2" data-line-number="2">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;worked-examples.xlsx&quot;</span>, <span class="dt">package =</span> <span class="st">&quot;unpivotr&quot;</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3">x &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>)</a>
<a class="sourceLine" id="cb37-4" data-line-number="4"></a>
<a class="sourceLine" id="cb37-5" data-line-number="5"><span class="co"># Step 2: import one column of the table, taking only the formatting and not the</span></a>
<a class="sourceLine" id="cb37-6" data-line-number="6"><span class="co"># cell values</span></a>
<a class="sourceLine" id="cb37-7" data-line-number="7"></a>
<a class="sourceLine" id="cb37-8" data-line-number="8"><span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9"><span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span></a>
<a class="sourceLine" id="cb37-10" data-line-number="10">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb37-11" data-line-number="11"></a>
<a class="sourceLine" id="cb37-12" data-line-number="12"><span class="co"># Import all the cells, filter out the header row, filter for the first column,</span></a>
<a class="sourceLine" id="cb37-13" data-line-number="13"><span class="co"># and create new columns `something_fill` of the fill colours, by looking up the</span></a>
<a class="sourceLine" id="cb37-14" data-line-number="14"><span class="co"># local_format_id of each cell in the `formats` pallette.</span></a>
<a class="sourceLine" id="cb37-15" data-line-number="15">fills &lt;-</a>
<a class="sourceLine" id="cb37-16" data-line-number="16"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-17" data-line-number="17"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>, col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the header row and name column</span></a>
<a class="sourceLine" id="cb37-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-19" data-line-number="19"><span class="st">  </span><span class="kw">select</span>(row, col, fill_colour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-20" data-line-number="20"><span class="st">  </span><span class="kw">spread</span>(col, fill_colour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-22" data-line-number="22"><span class="st">  </span><span class="kw">set_names</span>(<span class="kw">paste0</span>(<span class="kw">colnames</span>(x)[<span class="op">-</span><span class="dv">1</span>], <span class="st">&quot;_fill&quot;</span>))</a>
<a class="sourceLine" id="cb37-23" data-line-number="23">fills</a></code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   Age_fill Height_fill
##   &lt;chr&gt;    &lt;chr&gt;      
## 1 &lt;NA&gt;     &lt;NA&gt;       
## 2 FFFFFF00 &lt;NA&gt;       
## 3 &lt;NA&gt;     FF92D050</code></pre>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="co"># Step 3: append the `fill` column to the rest of the data</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="kw">bind_cols</span>(x, fills)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 5
##   Name       Age Height Age_fill Height_fill
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      
## 1 Matilda      1      2 &lt;NA&gt;     &lt;NA&gt;       
## 2 Nicholas     3      4 FFFFFF00 &lt;NA&gt;       
## 3 Olivia       5      6 &lt;NA&gt;     FF92D050</code></pre>
<p>Here’s the same thing, but using only tidyxl and unpivotr</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb41-2" data-line-number="2"></a>
<a class="sourceLine" id="cb41-3" data-line-number="3">cells &lt;-</a>
<a class="sourceLine" id="cb41-4" data-line-number="4"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-6" data-line-number="6"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, fill_colour)</a>
<a class="sourceLine" id="cb41-7" data-line-number="7">cells</a></code></pre></div>
<pre><code>## # A tibble: 12 x 6
##      row   col data_type character numeric fill_colour
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;      
##  1     1     1 character Name           NA &lt;NA&gt;       
##  2     1     2 character Age            NA &lt;NA&gt;       
##  3     1     3 character Height         NA &lt;NA&gt;       
##  4     2     1 character Matilda        NA &lt;NA&gt;       
##  5     2     2 numeric   &lt;NA&gt;            1 &lt;NA&gt;       
##  6     2     3 numeric   &lt;NA&gt;            2 &lt;NA&gt;       
##  7     3     1 character Nicholas       NA &lt;NA&gt;       
##  8     3     2 numeric   &lt;NA&gt;            3 FFFFFF00   
##  9     3     3 numeric   &lt;NA&gt;            4 &lt;NA&gt;       
## 10     4     1 character Olivia         NA &lt;NA&gt;       
## 11     4     2 numeric   &lt;NA&gt;            5 &lt;NA&gt;       
## 12     4     3 numeric   &lt;NA&gt;            6 FF92D050</code></pre>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">values &lt;-</a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="st">  </span>cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>fill_colour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-4" data-line-number="4"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, header) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>col) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-6" data-line-number="6"><span class="st">  </span><span class="kw">spatter</span>(header)</a>
<a class="sourceLine" id="cb43-7" data-line-number="7">values</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##     row   Age Height Name    
##   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;   
## 1     2     1      2 Matilda 
## 2     3     3      4 Nicholas
## 3     4     5      6 Olivia</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">fills &lt;-</a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="st">  </span>cells <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, header) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">header =</span> <span class="kw">paste0</span>(header, <span class="st">&quot;_fill&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, header, fill_colour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-6" data-line-number="6"><span class="st">  </span><span class="kw">spread</span>(header, fill_colour)</a>
<a class="sourceLine" id="cb45-7" data-line-number="7">fills</a></code></pre></div>
<pre><code>## # A tibble: 3 x 4
##     row Age_fill Height_fill Name_fill
##   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;    
## 1     2 &lt;NA&gt;     &lt;NA&gt;        &lt;NA&gt;     
## 2     3 FFFFFF00 &lt;NA&gt;        &lt;NA&gt;     
## 3     4 &lt;NA&gt;     FF92D050    &lt;NA&gt;</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="kw">left_join</span>(values, fills, <span class="dt">by =</span> <span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>row)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 6
##     Age Height Name     Age_fill Height_fill Name_fill
##   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;    
## 1     1      2 Matilda  &lt;NA&gt;     &lt;NA&gt;        &lt;NA&gt;     
## 2     3      4 Nicholas FFFFFF00 &lt;NA&gt;        &lt;NA&gt;     
## 3     5      6 Olivia   &lt;NA&gt;     FF92D050    &lt;NA&gt;</code></pre>
<p>Another way would be to make the table what I call “extra-tidy”. If it is tidy,
then each row is an observation, and each column is a variable. To make it
“extra-tidy”, you <code>gather()</code> the variables so that each row is <em>one observation
of one variable</em>. This works best when every variable has the same data type,
otherwise the values will be coerced, probably to a character.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="co"># Tidy</span></a>
<a class="sourceLine" id="cb49-2" data-line-number="2">(x &lt;-<span class="st"> </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   Name       Age Height
##   &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;
## 1 Matilda      1      2
## 2 Nicholas     3      4
## 3 Olivia       5      6</code></pre>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="co"># Extra-tidy</span></a>
<a class="sourceLine" id="cb51-2" data-line-number="2">extra_tidy &lt;-</a>
<a class="sourceLine" id="cb51-3" data-line-number="3"><span class="st">  </span>x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-4" data-line-number="4"><span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>Name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-5" data-line-number="5"><span class="st">  </span><span class="kw">arrange</span>(Name, variable)</a>
<a class="sourceLine" id="cb51-6" data-line-number="6">extra_tidy</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   Name     variable value
##   &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
## 1 Matilda  Age          1
## 2 Matilda  Height       2
## 3 Nicholas Age          3
## 4 Nicholas Height       4
## 5 Olivia   Age          5
## 6 Olivia   Height       6</code></pre>
<p>With an extra-tidy dataset, the formatting can now be appended to the values of
individual variables, rather than to whole observations.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="co"># Extra-tidy, with row and column numbers of the original variables</span></a>
<a class="sourceLine" id="cb53-2" data-line-number="2">extra_tidy &lt;-</a>
<a class="sourceLine" id="cb53-3" data-line-number="3"><span class="st">  </span><span class="kw">read_excel</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row =</span> <span class="kw">row_number</span>() <span class="op">+</span><span class="st"> </span>1L) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(variable, value, <span class="op">-</span>row, <span class="op">-</span>Name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(row) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">col =</span> <span class="kw">row_number</span>() <span class="op">+</span><span class="st"> </span>1L) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-8" data-line-number="8"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(row, col, Name, variable, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-10" data-line-number="10"><span class="st">  </span><span class="kw">arrange</span>(row, col)</a>
<a class="sourceLine" id="cb53-11" data-line-number="11">extra_tidy</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##     row   col Name     variable value
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt;
## 1     2     2 Matilda  Age          1
## 2     2     3 Matilda  Height       2
## 3     3     2 Nicholas Age          3
## 4     3     3 Nicholas Height       4
## 5     4     2 Olivia   Age          5
## 6     4     3 Olivia   Height       6</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="co"># `formats` is a pallette of fill colours that can be indexed by the</span></a>
<a class="sourceLine" id="cb55-2" data-line-number="2"><span class="co"># `local_format_id` of a given cell to get the fill colour of that cell</span></a>
<a class="sourceLine" id="cb55-3" data-line-number="3">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb55-4" data-line-number="4"></a>
<a class="sourceLine" id="cb55-5" data-line-number="5"><span class="co"># Import all the cells, filter out the header row, filter for the first column,</span></a>
<a class="sourceLine" id="cb55-6" data-line-number="6"><span class="co"># and create a new column `uncertain` based on the fill colours, by looking up</span></a>
<a class="sourceLine" id="cb55-7" data-line-number="7"><span class="co"># the local_format_id of each cell in the `formats` pallette.</span></a>
<a class="sourceLine" id="cb55-8" data-line-number="8">fills &lt;-</a>
<a class="sourceLine" id="cb55-9" data-line-number="9"><span class="st">  </span><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>, col <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Omit the header row and name column</span></a>
<a class="sourceLine" id="cb55-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(row, col, fill_colour)</a>
<a class="sourceLine" id="cb55-13" data-line-number="13">fills</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##     row   col fill_colour
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;      
## 1     2     2 &lt;NA&gt;       
## 2     2     3 &lt;NA&gt;       
## 3     3     2 FFFFFF00   
## 4     3     3 &lt;NA&gt;       
## 5     4     2 &lt;NA&gt;       
## 6     4     3 FF92D050</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="co"># Step 3: append the `fill` column to the rest of the data</span></a>
<a class="sourceLine" id="cb57-2" data-line-number="2"><span class="kw">left_join</span>(extra_tidy, fills, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;row&quot;</span>, <span class="st">&quot;col&quot;</span>))</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##     row   col Name     variable value fill_colour
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      
## 1     2     2 Matilda  Age          1 &lt;NA&gt;       
## 2     2     3 Matilda  Height       2 &lt;NA&gt;       
## 3     3     2 Nicholas Age          3 FFFFFF00   
## 4     3     3 Nicholas Height       4 &lt;NA&gt;       
## 5     4     2 Olivia   Age          5 &lt;NA&gt;       
## 6     4     3 Olivia   Height       6 FF92D050</code></pre>
<p>Here’s the same extra-tidy version, but using only tidyxl and unpivotr.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" data-line-number="1">fill_colours &lt;-<span class="st"> </span><span class="kw">xlsx_formats</span>(path)<span class="op">$</span>local<span class="op">$</span>fill<span class="op">$</span>patternFill<span class="op">$</span>fgColor<span class="op">$</span>rgb</a>
<a class="sourceLine" id="cb59-2" data-line-number="2"></a>
<a class="sourceLine" id="cb59-3" data-line-number="3"><span class="kw">xlsx_cells</span>(path, <span class="dt">sheet =</span> <span class="st">&quot;annotations&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fill_colour =</span> fill_colours[local_format_id]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(row, col, data_type, character, numeric, fill_colour) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-6" data-line-number="6"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;W&quot;</span>, Name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-7" data-line-number="7"><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;N&quot;</span>, variable) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>data_type, <span class="op">-</span>character, <span class="dt">value =</span> numeric)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##     row   col value fill_colour Name     variable
##   &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   
## 1     2     2     1 &lt;NA&gt;        Matilda  Age     
## 2     2     3     2 &lt;NA&gt;        Matilda  Height  
## 3     3     2     3 FFFFFF00    Nicholas Age     
## 4     3     3     4 &lt;NA&gt;        Nicholas Height  
## 5     4     2     5 &lt;NA&gt;        Olivia   Age     
## 6     4     3     6 FF92D050    Olivia   Height</code></pre>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidy-formatted-rows.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="layered-formatting.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/nacnudus/spreadsheet-munging-strategies/edit/master/tidyish.Rmd",
"text": "Edit"
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "none"
}
});
});
</script>

</body>

</html>
