<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>9.4 Toronto Transit Commission | Spreadsheet Munging Strategies</title>
  <meta name="description" content="9.4 Toronto Transit Commission | Spreadsheet Munging Strategies" />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="9.4 Toronto Transit Commission | Spreadsheet Munging Strategies" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="9.4 Toronto Transit Commission | Spreadsheet Munging Strategies" />
  
  
  

<meta name="author" content="Duncan Garmonsway" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="us-crime.html"/>
<link rel="next" href="ground-water.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-45097885-10"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-45097885-10');
</script>



<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> Setup</a>
<ul>
<li class="chapter" data-level="1.1" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="tidyish.html"><a href="tidyish.html"><i class="fa fa-check"></i><b>2</b> Tidy-ish tables</a>
<ul>
<li class="chapter" data-level="2.1" data-path="tidy-clean.html"><a href="tidy-clean.html"><i class="fa fa-check"></i><b>2.1</b> Clean &amp; tidy tables</a></li>
<li class="chapter" data-level="2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html"><i class="fa fa-check"></i><b>2.2</b> Almost-tidy tables</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#transposed-headers-in-the-first-row-data-extends-to-the-right"><i class="fa fa-check"></i><b>2.2.1</b> Transposed (headers in the first row, data extends to the right)</a></li>
<li class="chapter" data-level="2.2.2" data-path="almost-tidy-tables.html"><a href="almost-tidy-tables.html#other-stuff-on-the-same-sheet"><i class="fa fa-check"></i><b>2.2.2</b> Other stuff on the same sheet</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="tidy-formatted-rows.html"><a href="tidy-formatted-rows.html"><i class="fa fa-check"></i><b>2.3</b> Meaningfully formatted rows</a></li>
<li class="chapter" data-level="2.4" data-path="tidy-formatted-cells.html"><a href="tidy-formatted-cells.html"><i class="fa fa-check"></i><b>2.4</b> Meaningfully formatted cells</a></li>
<li class="chapter" data-level="2.5" data-path="layered-formatting.html"><a href="layered-formatting.html"><i class="fa fa-check"></i><b>2.5</b> Layered meaningful formatting</a></li>
<li class="chapter" data-level="2.6" data-path="hierarchies-in-formatting.html"><a href="hierarchies-in-formatting.html"><i class="fa fa-check"></i><b>2.6</b> Hierarchies in formatting</a></li>
<li class="chapter" data-level="2.7" data-path="tidy-sentinel.html"><a href="tidy-sentinel.html"><i class="fa fa-check"></i><b>2.7</b> Sentinel values in non-text columns</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="pivot.html"><a href="pivot.html"><i class="fa fa-check"></i><b>3</b> Pivot tables</a>
<ul>
<li class="chapter" data-level="3.1" data-path="pivot-simple.html"><a href="pivot-simple.html"><i class="fa fa-check"></i><b>3.1</b> Simple unpivoting</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-of-text-column-headers-left-aligned"><i class="fa fa-check"></i><b>3.1.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.1.2" data-path="pivot-simple.html"><a href="pivot-simple.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned"><i class="fa fa-check"></i><b>3.1.2</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.1.3" data-path="pivot-simple.html"><a href="pivot-simple.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting"><i class="fa fa-check"></i><b>3.1.3</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="3.1.4" data-path="pivot-simple.html"><a href="pivot-simple.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.1.4</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.1.5" data-path="pivot-simple.html"><a href="pivot-simple.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting"><i class="fa fa-check"></i><b>3.1.5</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="pivot-complex.html"><a href="pivot-complex.html"><i class="fa fa-check"></i><b>3.2</b> Complex unpivoting</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-of-text-column-headers-left-aligned-1"><i class="fa fa-check"></i><b>3.2.1</b> Two clear rows of text column headers, left-aligned</a></li>
<li class="chapter" data-level="3.2.2" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-columns-of-text-row-headers-top-aligned"><i class="fa fa-check"></i><b>3.2.2</b> Two clear columns of text row headers, top-aligned</a></li>
<li class="chapter" data-level="3.2.3" data-path="pivot-complex.html"><a href="pivot-complex.html#two-clear-rows-and-columns-of-text-headers-top-aligned-and-left-aligned-1"><i class="fa fa-check"></i><b>3.2.3</b> Two clear rows and columns of text headers, top-aligned and left-aligned</a></li>
<li class="chapter" data-level="3.2.4" data-path="pivot-complex.html"><a href="pivot-complex.html#centre-aligned-headers"><i class="fa fa-check"></i><b>3.2.4</b> Centre-aligned headers</a></li>
<li class="chapter" data-level="3.2.5" data-path="pivot-complex.html"><a href="pivot-complex.html#multiple-rows-or-columns-of-headers-with-meaningful-formatting-1"><i class="fa fa-check"></i><b>3.2.5</b> Multiple rows or columns of headers, with meaningful formatting</a></li>
<li class="chapter" data-level="3.2.6" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-headers-and-notes-in-the-same-rowcolumn-distinguished-by-formatting-1"><i class="fa fa-check"></i><b>3.2.6</b> Mixed headers and notes in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.7" data-path="pivot-complex.html"><a href="pivot-complex.html#mixed-levels-of-headers-in-the-same-rowcolumn-distinguished-by-formatting-1"><i class="fa fa-check"></i><b>3.2.7</b> Mixed levels of headers in the same row/column, distinguished by formatting</a></li>
<li class="chapter" data-level="3.2.8" data-path="pivot-complex.html"><a href="pivot-complex.html#repeated-rowscolumns-of-headers-within-the-table"><i class="fa fa-check"></i><b>3.2.8</b> Repeated rows/columns of headers within the table</a></li>
<li class="chapter" data-level="3.2.9" data-path="pivot-complex.html"><a href="pivot-complex.html#headers-amongst-the-data"><i class="fa fa-check"></i><b>3.2.9</b> Headers amongst the data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="small-multiples.html"><a href="small-multiples.html"><i class="fa fa-check"></i><b>4</b> Small multiples</a>
<ul>
<li class="chapter" data-level="4.1" data-path="small-multiples-with-all-headers-present-for-each-multiple.html"><a href="small-multiples-with-all-headers-present-for-each-multiple.html"><i class="fa fa-check"></i><b>4.1</b> Small multiples with all headers present for each multiple</a></li>
<li class="chapter" data-level="4.2" data-path="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><a href="same-table-in-several-worksheetsfiles-using-the-sheetfile-name.html"><i class="fa fa-check"></i><b>4.2</b> Same table in several worksheets/files (using the sheet/file name)</a></li>
<li class="chapter" data-level="4.3" data-path="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><a href="same-table-in-several-worksheetsfiles-but-in-different-positions.html"><i class="fa fa-check"></i><b>4.3</b> Same table in several worksheets/files but in different positions</a></li>
<li class="chapter" data-level="4.4" data-path="implied-multiples.html"><a href="implied-multiples.html"><i class="fa fa-check"></i><b>4.4</b> Implied multiples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="formatting.html"><a href="formatting.html"><i class="fa fa-check"></i><b>5</b> Formatting</a>
<ul>
<li class="chapter" data-level="5.1" data-path="an-example-formatting-lookup.html"><a href="an-example-formatting-lookup.html"><i class="fa fa-check"></i><b>5.1</b> An example formatting lookup</a></li>
<li class="chapter" data-level="5.2" data-path="common-formats.html"><a href="common-formats.html"><i class="fa fa-check"></i><b>5.2</b> Common formats</a></li>
<li class="chapter" data-level="5.3" data-path="in-cell-formatting.html"><a href="in-cell-formatting.html"><i class="fa fa-check"></i><b>5.3</b> In-cell formatting</a></li>
<li class="chapter" data-level="5.4" data-path="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><a href="multiple-pieces-of-information-in-a-single-cell-with-meaningful-formatting.html"><i class="fa fa-check"></i><b>5.4</b> Multiple pieces of information in a single cell, with meaningful formatting</a></li>
<li class="chapter" data-level="5.5" data-path="superscript-symbols.html"><a href="superscript-symbols.html"><i class="fa fa-check"></i><b>5.5</b> Superscript symbols</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-validation.html"><a href="data-validation.html"><i class="fa fa-check"></i><b>6</b> Data validation</a></li>
<li class="chapter" data-level="7" data-path="formulas.html"><a href="formulas.html"><i class="fa fa-check"></i><b>7</b> Formulas</a></li>
<li class="chapter" data-level="8" data-path="other-gotchas.html"><a href="other-gotchas.html"><i class="fa fa-check"></i><b>8</b> Other gotchas</a>
<ul>
<li class="chapter" data-level="8.1" data-path="non-text-headers-e-g-dates.html"><a href="non-text-headers-e-g-dates.html"><i class="fa fa-check"></i><b>8.1</b> Non-text headers e.g. dates</a></li>
<li class="chapter" data-level="8.2" data-path="data-embedded-in-comments.html"><a href="data-embedded-in-comments.html"><i class="fa fa-check"></i><b>8.2</b> Data embedded in comments</a></li>
<li class="chapter" data-level="8.3" data-path="named-ranges.html"><a href="named-ranges.html"><i class="fa fa-check"></i><b>8.3</b> Named ranges</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="case-studies.html"><a href="case-studies.html"><i class="fa fa-check"></i><b>9</b> Case studies</a>
<ul>
<li class="chapter" data-level="9.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html"><i class="fa fa-check"></i><b>9.1</b> Australian Marriage Survey</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#the-full-code-listing"><i class="fa fa-check"></i><b>9.1.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.1.2" data-path="australian-marriage-survey.html"><a href="australian-marriage-survey.html#step-by-step"><i class="fa fa-check"></i><b>9.1.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="vaccinations.html"><a href="vaccinations.html"><i class="fa fa-check"></i><b>9.2</b> Vaccinations</a></li>
<li class="chapter" data-level="9.3" data-path="us-crime.html"><a href="us-crime.html"><i class="fa fa-check"></i><b>9.3</b> US Crime</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="us-crime.html"><a href="us-crime.html#us-crime-2"><i class="fa fa-check"></i><b>9.3.1</b> Table 2</a></li>
<li class="chapter" data-level="9.3.2" data-path="us-crime.html"><a href="us-crime.html#us-crime-3"><i class="fa fa-check"></i><b>9.3.2</b> Table 3</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html"><i class="fa fa-check"></i><b>9.4</b> Toronto Transit Commission</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#the-full-code-listing-1"><i class="fa fa-check"></i><b>9.4.1</b> The full code listing</a></li>
<li class="chapter" data-level="9.4.2" data-path="toronto-transit-commission.html"><a href="toronto-transit-commission.html#step-by-step-1"><i class="fa fa-check"></i><b>9.4.2</b> Step by step</a></li>
</ul></li>
<li class="chapter" data-level="9.5" data-path="ground-water.html"><a href="ground-water.html"><i class="fa fa-check"></i><b>9.5</b> Ground water</a></li>
<li class="chapter" data-level="9.6" data-path="cashflows.html"><a href="cashflows.html"><i class="fa fa-check"></i><b>9.6</b> Cashflows</a></li>
<li class="chapter" data-level="9.7" data-path="school-performance.html"><a href="school-performance.html"><i class="fa fa-check"></i><b>9.7</b> School performance</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="school-performance.html"><a href="school-performance.html#sheet-1"><i class="fa fa-check"></i><b>9.7.1</b> Sheet 1</a></li>
<li class="chapter" data-level="9.7.2" data-path="school-performance.html"><a href="school-performance.html#sheet-2"><i class="fa fa-check"></i><b>9.7.2</b> Sheet 2</a></li>
<li class="chapter" data-level="9.7.3" data-path="school-performance.html"><a href="school-performance.html#sheet-3"><i class="fa fa-check"></i><b>9.7.3</b> Sheet 3</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spreadsheet Munging Strategies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="toronto-transit-commission" class="section level2" number="9.4">
<h2><span class="header-section-number">9.4</span> Toronto Transit Commission</h2>
<p><a href="https://twitter.com/sharlagelfand/status/996739127562391552"><img src="images/toronto-tweet.png" alt="Tweet by Sharla Gelfand about tidying Toronto Transit Commission data with R" /></a></p>
<p>This table shows the number of trips recorded on the Toronto Transit Commission
per year, by type of ticket, person, vehicle, and weeday/weekend/holiday.</p>
<p>Sharla Gelfand’s annotated screenshot explains the structure, and see her
excellent <a href="https://sharlagelfand.netlify.com/posts/tidy-ttc/">blog post</a> for how
she wrangled it with standard tidyverse tools. I show here an alternative
method with tidyxl and unpivotr.</p>
<p><a href="https://github.com/nacnudus/smungs/blob/master/inst/extdata/toronto_transit.xlsx?raw=true">Download the
file</a>.
<a href="https://portal0.cf.opendata.inter.sandbox-toronto.ca/dataset/ttc-ridership-analysis">Original
source</a>.</p>
<div id="the-full-code-listing-1" class="section level3" number="9.4.1">
<h3><span class="header-section-number">9.4.1</span> The full code listing</h3>
<div class="sourceCode" id="cb384"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb384-1"><a href="toronto-transit-commission.html#cb384-1"></a>cells &lt;-</span>
<span id="cb384-2"><a href="toronto-transit-commission.html#cb384-2"></a><span class="st">  </span><span class="kw">xlsx_cells</span>(smungs<span class="op">::</span>toronto_transit) <span class="op">%&gt;%</span></span>
<span id="cb384-3"><a href="toronto-transit-commission.html#cb384-3"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank, row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">6</span>)</span>
<span id="cb384-4"><a href="toronto-transit-commission.html#cb384-4"></a></span>
<span id="cb384-5"><a href="toronto-transit-commission.html#cb384-5"></a>fare &lt;-</span>
<span id="cb384-6"><a href="toronto-transit-commission.html#cb384-6"></a><span class="st">  </span>cells <span class="op">%&gt;%</span></span>
<span id="cb384-7"><a href="toronto-transit-commission.html#cb384-7"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb384-8"><a href="toronto-transit-commission.html#cb384-8"></a>                <span class="op">!</span><span class="kw">str_detect</span>(character, <span class="st">&quot;^ &quot;</span>),</span>
<span id="cb384-9"><a href="toronto-transit-commission.html#cb384-9"></a>                <span class="op">!</span><span class="kw">str_detect</span>(character, <span class="st">&quot;TOTAL&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb384-10"><a href="toronto-transit-commission.html#cb384-10"></a><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">fare =</span> character)</span>
<span id="cb384-11"><a href="toronto-transit-commission.html#cb384-11"></a></span>
<span id="cb384-12"><a href="toronto-transit-commission.html#cb384-12"></a>cells <span class="op">%&gt;%</span></span>
<span id="cb384-13"><a href="toronto-transit-commission.html#cb384-13"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;up&quot;</span>, <span class="st">&quot;year&quot;</span>, <span class="dt">formatters =</span> <span class="kw">list</span>(<span class="dt">character =</span> str_trim)) <span class="op">%&gt;%</span></span>
<span id="cb384-14"><a href="toronto-transit-commission.html#cb384-14"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;left-up&quot;</span>, <span class="st">&quot;context&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb384-15"><a href="toronto-transit-commission.html#cb384-15"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;media&quot;</span>, <span class="dt">formatters =</span> <span class="kw">list</span>(<span class="dt">character =</span> str_trim)) <span class="op">%&gt;%</span></span>
<span id="cb384-16"><a href="toronto-transit-commission.html#cb384-16"></a><span class="st">  </span><span class="kw">enhead</span>(fare, <span class="st">&quot;left-up&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb384-17"><a href="toronto-transit-commission.html#cb384-17"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(media, <span class="st">&quot;TOTAL&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb384-18"><a href="toronto-transit-commission.html#cb384-18"></a><span class="st">  </span><span class="kw">separate</span>(year, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;note&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;right&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb384-19"><a href="toronto-transit-commission.html#cb384-19"></a><span class="st">  </span><span class="kw">select</span>(year, context, fare, media, <span class="dt">count =</span> numeric)</span></code></pre></div>
<pre><code>## # A tibble: 1,188 x 5
##    year  context fare  media   count
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
##  1 2017  WHO     ADULT TOKENS  76106
##  2 2016  WHO     ADULT TOKENS 102073
##  3 2015  WHO     ADULT TOKENS 110945
##  4 2014  WHO     ADULT TOKENS 111157
##  5 2013  WHO     ADULT TOKENS 112360
##  6 2012  WHO     ADULT TOKENS 117962
##  7 2011  WHO     ADULT TOKENS 124748
##  8 2010  WHO     ADULT TOKENS 120366
##  9 2009  WHO     ADULT TOKENS 114686
## 10 2008  WHO     ADULT TOKENS  94210
## # … with 1,178 more rows</code></pre>
</div>
<div id="step-by-step-1" class="section level3" number="9.4.2">
<h3><span class="header-section-number">9.4.2</span> Step by step</h3>
<p>Although the annotations point out that there are really three separate tables
(<code>WHO</code>, <code>WHERE</code> and <code>WHEN</code>), they can be imported as one.</p>
<p>Column 2 has two levels of headers in it: the fare in bold (“ADULT”, “BUS”,
etc.), and the media used to pay for it indented by a few spaces (“TOKENS”,
“WEEKLY PASS”, etc.).</p>
<p>Because <code>behead()</code> can’t distinguish between different levels of headers in the
same column, we need to put the bold fare headers into a separate variable on
their own, and <code>enhead()</code> them back onto the rest of the table later.</p>
<p>Unfortunately the fare headers in the “WHEN” context aren’t bold, so rather than
filter for bold headers, instead we filter for headers that aren’t indented by
spaces. We also filter out any “TOTAL” headers.</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb386-1"><a href="toronto-transit-commission.html#cb386-1"></a>cells &lt;-</span>
<span id="cb386-2"><a href="toronto-transit-commission.html#cb386-2"></a><span class="st">  </span><span class="kw">xlsx_cells</span>(smungs<span class="op">::</span>toronto_transit) <span class="op">%&gt;%</span></span>
<span id="cb386-3"><a href="toronto-transit-commission.html#cb386-3"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span>is_blank, row <span class="op">&gt;=</span><span class="st"> </span><span class="dv">6</span>)</span>
<span id="cb386-4"><a href="toronto-transit-commission.html#cb386-4"></a></span>
<span id="cb386-5"><a href="toronto-transit-commission.html#cb386-5"></a>fare &lt;-</span>
<span id="cb386-6"><a href="toronto-transit-commission.html#cb386-6"></a><span class="st">  </span>cells <span class="op">%&gt;%</span></span>
<span id="cb386-7"><a href="toronto-transit-commission.html#cb386-7"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(col <span class="op">==</span><span class="st"> </span><span class="dv">2</span>,</span>
<span id="cb386-8"><a href="toronto-transit-commission.html#cb386-8"></a>                <span class="op">!</span><span class="kw">str_detect</span>(character, <span class="st">&quot;^ &quot;</span>), <span class="co"># Filter out indented headers</span></span>
<span id="cb386-9"><a href="toronto-transit-commission.html#cb386-9"></a>                <span class="op">!</span><span class="kw">str_detect</span>(character, <span class="st">&quot;TOTAL&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Filteroout totals</span></span>
<span id="cb386-10"><a href="toronto-transit-commission.html#cb386-10"></a><span class="st">  </span><span class="kw">select</span>(row, col, <span class="dt">fare =</span> character)</span>
<span id="cb386-11"><a href="toronto-transit-commission.html#cb386-11"></a>fare</span></code></pre></div>
<pre><code>## # A tibble: 7 x 3
##     row   col fare           
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;          
## 1     7     2 ADULT          
## 2    21     2 SENIOR/STUDENT 
## 3    31     2 CHILDREN       
## 4    43     2 BUS            
## 5    46     2 RAIL           
## 6    53     2 WEEKDAY        
## 7    54     2 WEEKEND/HOLIDAY</code></pre>
<div class="sourceCode" id="cb388"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb388-1"><a href="toronto-transit-commission.html#cb388-1"></a>ttc &lt;-</span>
<span id="cb388-2"><a href="toronto-transit-commission.html#cb388-2"></a><span class="st">  </span>cells <span class="op">%&gt;%</span></span>
<span id="cb388-3"><a href="toronto-transit-commission.html#cb388-3"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;up&quot;</span>, <span class="st">&quot;year&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb388-4"><a href="toronto-transit-commission.html#cb388-4"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;left-up&quot;</span>, <span class="st">&quot;context&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb388-5"><a href="toronto-transit-commission.html#cb388-5"></a><span class="st">  </span><span class="kw">behead</span>(<span class="st">&quot;left&quot;</span>, <span class="st">&quot;media&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb388-6"><a href="toronto-transit-commission.html#cb388-6"></a><span class="st">  </span><span class="kw">enhead</span>(fare, <span class="st">&quot;left-up&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb388-7"><a href="toronto-transit-commission.html#cb388-7"></a><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(media, <span class="st">&quot;TOTAL&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb388-8"><a href="toronto-transit-commission.html#cb388-8"></a><span class="st">  </span><span class="kw">select</span>(year, context, fare, media, <span class="dt">count =</span> numeric)</span>
<span id="cb388-9"><a href="toronto-transit-commission.html#cb388-9"></a>ttc</span></code></pre></div>
<pre><code>## # A tibble: 1,188 x 5
##    year      context fare  media          count
##    &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;          &lt;dbl&gt;
##  1 &quot;2017&quot;    WHO     ADULT &quot;     TOKENS&quot;  76106
##  2 &quot;2016&quot;    WHO     ADULT &quot;     TOKENS&quot; 102073
##  3 &quot; 2015 *&quot; WHO     ADULT &quot;     TOKENS&quot; 110945
##  4 &quot;2014&quot;    WHO     ADULT &quot;     TOKENS&quot; 111157
##  5 &quot;2013&quot;    WHO     ADULT &quot;     TOKENS&quot; 112360
##  6 &quot;2012&quot;    WHO     ADULT &quot;     TOKENS&quot; 117962
##  7 &quot;2011&quot;    WHO     ADULT &quot;     TOKENS&quot; 124748
##  8 &quot;2010&quot;    WHO     ADULT &quot;     TOKENS&quot; 120366
##  9 &quot;2009&quot;    WHO     ADULT &quot;     TOKENS&quot; 114686
## 10 &quot;2008&quot;    WHO     ADULT &quot;     TOKENS&quot;  94210
## # … with 1,178 more rows</code></pre>
<p>There’s a bit more cosmetic cleaning to do. The indentation can be trimmed from
the <code>media</code> and the <code>year</code> headers, and the asterisk removed from the year <code>2015 *</code>.</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb390-1"><a href="toronto-transit-commission.html#cb390-1"></a>ttc <span class="op">%&gt;%</span></span>
<span id="cb390-2"><a href="toronto-transit-commission.html#cb390-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">str_trim</span>(year), <span class="dt">media =</span> <span class="kw">str_trim</span>(media)) <span class="op">%&gt;%</span></span>
<span id="cb390-3"><a href="toronto-transit-commission.html#cb390-3"></a><span class="st">  </span><span class="kw">separate</span>(year, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;note&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;right&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb390-4"><a href="toronto-transit-commission.html#cb390-4"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>note)</span></code></pre></div>
<pre><code>## # A tibble: 1,188 x 5
##    year  context fare  media   count
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
##  1 2017  WHO     ADULT TOKENS  76106
##  2 2016  WHO     ADULT TOKENS 102073
##  3 2015  WHO     ADULT TOKENS 110945
##  4 2014  WHO     ADULT TOKENS 111157
##  5 2013  WHO     ADULT TOKENS 112360
##  6 2012  WHO     ADULT TOKENS 117962
##  7 2011  WHO     ADULT TOKENS 124748
##  8 2010  WHO     ADULT TOKENS 120366
##  9 2009  WHO     ADULT TOKENS 114686
## 10 2008  WHO     ADULT TOKENS  94210
## # … with 1,178 more rows</code></pre>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="us-crime.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ground-water.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"],
"google": true,
"instapper": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/nacnudus/spreadsheet-munging-strategies/edit/master/case-studies.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["spreadsheet-munging-strategies.pdf", "spreadsheet-munging-strategies.epub"],
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true
});
});
</script>

</body>

</html>
